<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DEEP • Карточка товара</title>
  <!-- Rendered client-side; data from Strapi (server). DO NOT TOUCH proxy/server configs. -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand: { 600:'#3a63f5', 700:'#2b4dd6' } }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-50 text-gray-900">
  <main class="max-w-6xl mx-auto p-4 md:p-6">
    <section class="bg-white shadow-sm rounded-xl border border-gray-200 overflow-hidden">
      <div class="px-4 md:px-6 py-4 border-b flex items-center justify-between gap-4 flex-wrap">
        <div>
          <h1 class="text-lg md:text-xl font-semibold">Карточка товара</h1>
          <p class="text-sm text-gray-600">Артикул (MPN): <span class="font-mono" id="mpn">—</span></p>
        </div>
        <a id="sourceLink" target="_blank" class="text-sm text-brand-700 hover:underline hidden">Источник</a>
      </div>

      <div class="p-4 md:p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Галерея -->
        <div>
          <div class="aspect-square bg-gray-100 rounded-xl overflow-hidden flex items-center justify-center">
            <img id="mainImg" alt="product" class="max-h-full max-w-full object-contain" />
          </div>
          <div id="thumbs" class="mt-3 grid grid-cols-5 gap-3"></div>
        </div>

        <!-- Инфо -->
        <div class="space-y-4">
          <div>
            <h2 class="font-semibold mb-1">Описание</h2>
            <p id="desc" class="text-sm text-gray-800"></p>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="p-3 rounded-lg border">
              <div class="text-xs text-gray-500 mb-1">Наличие</div>
              <div id="avail" class="text-sm">—</div>
            </div>
            <div class="p-3 rounded-lg border">
              <div class="text-xs text-gray-500 mb-1">Корпус</div>
              <div id="pkg" class="text-sm">—</div>
            </div>
            <div class="p-3 rounded-lg border">
              <div class="text-xs text-gray-500 mb-1">Упаковка</div>
              <div id="packaging" class="text-sm">—</div>
            </div>
            <div class="p-3 rounded-lg border">
              <div class="text-xs text-gray-500 mb-1">PDF / Datasheets</div>
              <div id="pdfs" class="text-sm space-y-1">—</div>
            </div>
          </div>

          <div>
            <h2 class="font-semibold mb-2">Цена</h2>
            <div id="pricing" class="text-sm">—</div>
          </div>
        </div>
      </div>

      <div class="px-4 md:px-6 pb-6">
        <h2 class="font-semibold mb-2">Технические характеристики</h2>
        <div id="specsWrap" class="overflow-x-auto">
          <table class="min-w-full text-sm border border-gray-200 rounded-lg overflow-hidden">
            <tbody id="specs"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ==== Конфиг API ====
    const API_BASE = ''; // относительные пути /api/products/:mpn
    const getParam = (k) => new URLSearchParams(location.search).get(k) || '';

    function currency(code) {
      if (!code) return '$';
      const m = { USD:'$', EUR:'€', RUB:'₽' };
      return m[code] || (code + ' ');
    }

    function availabilityCell(av) {
      if (!av || (av.inStock == null && !av.lead)) return '—';
      if (Number(av.inStock) > 0) {
        return `<span class="inline-flex items-center gap-2">
          <span class="h-2.5 w-2.5 rounded-full bg-emerald-500"></span>
          В наличии: ${Number(av.inStock).toLocaleString('ru-RU')}
        </span>`;
      }
      return `<span class="inline-flex items-center gap-2">
        <span class="h-2.5 w-2.5 rounded-full bg-amber-500"></span>
        Нет в наличии${av.lead ? ` • поставка ${av.lead}` : ''}
      </span>`;
    }

    function renderPricing(list) {
      if (!Array.isArray(list) || !list.length) return '—';
      const rows = list
        .slice()
        .sort((a,b)=>a.qty-b.qty)
        .map(t => `${t.qty}+: ${currency(t.currency)}${Number(t.price).toFixed(3)}${t.supplier ? ` <span class="text-xs text-gray-500">(${t.supplier})</span>`:''}`);
      return rows.join(' • ');
    }

    function setText(id, val) {
      document.getElementById(id).textContent = val || '—';
    }

    function renderImages(imgs) {
      const $main = document.getElementById('mainImg');
      const $thumbs = document.getElementById('thumbs');
      $thumbs.innerHTML = '';
      if (!Array.isArray(imgs) || imgs.length === 0) {
        $main.src = '';
        $main.alt = 'no image';
        return;
      }
      $main.src = imgs[0];
      imgs.slice(0,10).forEach((src, i) => {
        const btn = document.createElement('button');
        btn.className = 'aspect-square rounded-lg overflow-hidden border hover:ring-2 hover:ring-brand-600';
        btn.innerHTML = `<img src="${src}" alt="thumb ${i+1}" class="w-full h-full object-cover">`;
        btn.addEventListener('click', () => { $main.src = src; });
        $thumbs.appendChild(btn);
      });
    }

    function renderPDFs(list) {
      const $pdfs = document.getElementById('pdfs');
      if (!Array.isArray(list) || !list.length) { $pdfs.textContent = '—'; return; }
      $pdfs.innerHTML = list.slice(0,8).map((u,i)=>`<a href="${u}" target="_blank" class="text-brand-700 hover:underline">PDF ${i+1}</a>`).join('<br>');
    }

    function renderSpecs(specs) {
      const $tb = document.getElementById('specs');
      $tb.innerHTML = '';
      if (!specs || typeof specs !== 'object' || !Object.keys(specs).length) {
        $tb.innerHTML = '<tr><td class="px-4 py-2 text-gray-500">—</td></tr>';
        return;
      }
      const rows = Object.entries(specs).map(([k,v])=>`
        <tr class="border-b border-gray-200">
          <td class="px-4 py-2 w-1/3 font-medium bg-gray-50">${k}</td>
          <td class="px-4 py-2">${v}</td>
        </tr>
      `).join('');
      $tb.innerHTML = rows;
    }

    async function init() {
      const mpn = getParam('mpn').trim();
      if (!mpn) {
        setText('mpn', '—');
        document.getElementById('desc').textContent = 'Не указан параметр mpn в URL.';
        return;
      }
      setText('mpn', mpn);
      const url = `${API_BASE}/api/products/${encodeURIComponent(mpn)}`.replace(/^\/\//,'/');
      try {
        const res = await fetch(url, { credentials: 'include' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const p = await res.json();
        // Заполняем поля
        document.title = `DEEP • ${p.mpn || 'Товар'}`;
        setText('mpn', p.mpn || mpn);
        document.getElementById('desc').textContent = p.description || '—';
        document.getElementById('avail').innerHTML = availabilityCell(p.availability || {});
        setText('pkg', p.package || '—');
        setText('packaging', p.packaging || '—');
        document.getElementById('pricing').innerHTML = renderPricing(p.pricing || []);
        renderImages(p.images || []);
        renderPDFs(p.datasheets || []);
        renderSpecs(p.technical_specs || {});
        const a = document.getElementById('sourceLink');
        if (p.url) { a.href = p.url; a.classList.remove('hidden'); }
      } catch (e) {
        console.error(e);
        document.getElementById('desc').textContent = 'Ошибка загрузки данных. Проверь сервер/прокси.';
      }
    }

    init();
  </script>
</body>
</html>
