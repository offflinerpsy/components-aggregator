<!-- ORDER MODAL SNIPPET • drop into deep-product-template.html -->
<button id="btnOrder" class="mx-4 mb-4 px-4 py-2 rounded-lg border text-sm hover:bg-gray-50">Заказать</button>

<div id="orderModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
  <div class="bg-white w-full max-w-lg rounded-xl shadow-lg p-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold">Оформление заказа</h3>
      <button id="orderClose" class="text-gray-500 hover:text-gray-700">✕</button>
    </div>
    <form id="orderForm" class="grid grid-cols-1 gap-3">
      <div class="grid grid-cols-2 gap-3">
        <label class="text-sm">Имя
          <input name="name" required class="mt-1 w-full border rounded-md px-3 py-2" />
        </label>
        <label class="text-sm">Фамилия
          <input name="surname" class="mt-1 w-full border rounded-md px-3 py-2" />
        </label>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <label class="text-sm">Email
          <input type="email" name="email" required class="mt-1 w-full border rounded-md px-3 py-2" />
        </label>
        <label class="text-sm">Телефон
          <input name="phone" required class="mt-1 w-full border rounded-md px-3 py-2" />
        </label>
      </div>
      <label class="text-sm">Мессенджер (опц.)
        <input name="messenger" placeholder="Telegram: @user" class="mt-1 w-full border rounded-md px-3 py-2" />
      </label>
      <div class="grid grid-cols-2 gap-3">
        <label class="text-sm">Артикул (MPN)
          <input name="mpn" id="orderMPN" readonly class="mt-1 w-full border rounded-md px-3 py-2 bg-gray-50" />
        </label>
        <label class="text-sm">Количество
          <input type="number" name="quantity" value="1" min="1" required class="mt-1 w-full border rounded-md px-3 py-2" />
        </label>
      </div>
      <div class="text-right mt-2">
        <button type="button" id="orderCancel" class="mr-2 px-4 py-2 rounded-md border">Отмена</button>
        <button type="submit" class="px-4 py-2 rounded-md bg-brand-600 text-white hover:bg-brand-700">Отправить</button>
      </div>
      <p id="orderMsg" class="text-sm text-gray-600"></p>
    </form>
  </div>
</div>

<script>
  (function orderInit(){
    const modal = document.getElementById('orderModal');
    const openBtn = document.getElementById('btnOrder');
    const closeBtn = document.getElementById('orderClose');
    const cancelBtn = document.getElementById('orderCancel');
    const form = document.getElementById('orderForm');
    const msg = document.getElementById('orderMsg');
    const mpnEl = document.getElementById('orderMPN');
    const mpnText = document.getElementById('mpn')?.textContent?.trim() || '';
    mpnEl.value = mpnText || '';

    function open(){ modal.classList.remove('hidden'); modal.classList.add('flex'); msg.textContent=''; }
    function close(){ modal.classList.add('hidden'); modal.classList.remove('flex'); }
    openBtn?.addEventListener('click', open);
    closeBtn?.addEventListener('click', close);
    cancelBtn?.addEventListener('click', close);

    form?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const data = Object.fromEntries(new FormData(form).entries());
      const payload = {
        customer: {
          name: data.name, surname: data.surname || '', email: data.email, phone: data.phone, messenger: data.messenger || ''
        },
        item: { mpn: data.mpn, quantity: Number(data.quantity)||1 }
      };
      msg.textContent = 'Отправка…';
      try {
        const res = await fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('HTTP '+res.status);
        msg.textContent = 'Заявка отправлена. Мы свяжемся с вами.';
        setTimeout(close, 1200);
      } catch (err) {
        console.error(err);
        msg.textContent = 'Ошибка. Проверьте соединение/сервер.';
      }
    });
  })();
</script>
